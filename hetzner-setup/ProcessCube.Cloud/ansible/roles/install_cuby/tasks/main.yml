---
- name: Create processcube namespace
  shell: kubectl create namespace processcube --dry-run=client -o yaml | kubectl apply -f -
  changed_when: true

- name: Create ProcessCube Marketplace ImagePull Secret
  shell: |
    kubectl create secret docker-registry regcred \
      --docker-server=https://marketplace.processcube.io \
      --docker-username=processcube \
      --docker-password="{{ processcube_api_key }}" \
      -n processcube \
      --dry-run=client -o yaml | kubectl apply -f -
  changed_when: true

- name: Create ProcessCube API Key Secret
  shell: |
    kubectl create secret generic processcube-api-key \
      --from-literal=api-key="{{ processcube_api_key }}" \
      -n processcube \
      --dry-run=client -o yaml | kubectl apply -f -
  changed_when: true

- name: Get LoadBalancer IP from ingress-nginx
  shell: |
    kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
  register: loadbalancer_ip_result
  until: loadbalancer_ip_result.stdout != ""
  retries: 30
  delay: 10
  changed_when: false

- name: Set cuby_domain fact
  set_fact:
    cuby_domain: "cuby.{{ loadbalancer_ip_result.stdout }}.nip.io"

- name: Template Cuby Operator manifest
  template:
    src: cuby-operator.yaml.j2
    dest: /tmp/cuby-operator.yaml
    mode: '0644'

- name: Deploy Cuby Operator
  shell: kubectl apply -f /tmp/cuby-operator.yaml
  register: cuby_deploy
  changed_when: "'created' in cuby_deploy.stdout or 'configured' in cuby_deploy.stdout"

- name: Wait for Cuby Operator to be ready
  shell: |
    kubectl rollout status deployment/cuby-operator -n processcube --timeout=120s
  register: cuby_status
  changed_when: false

- name: Remove temporary manifest
  file:
    path: /tmp/cuby-operator.yaml
    state: absent

- name: Display Cuby setup info
  debug:
    msg:
      - "Cuby Operator deployed successfully in namespace 'processcube'"
      - ""
      - "Available secrets:"
      - "  - regcred (ImagePull Secret)"
      - "  - processcube-api-key (API Key Secret)"
      - ""
      - "Cuby is available at: https://{{ cuby_domain }}"
