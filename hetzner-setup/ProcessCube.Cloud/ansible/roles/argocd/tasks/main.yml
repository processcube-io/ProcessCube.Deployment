---
- name: Create ArgoCD namespace
  shell: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
  changed_when: true

- name: Install ArgoCD
  shell: |
    kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
  register: argocd_install
  changed_when: "'created' in argocd_install.stdout or 'configured' in argocd_install.stdout"

- name: Wait for ArgoCD pods to be ready
  shell: |
    ready_count=$(kubectl get pods -n argocd --field-selector=status.phase=Running --no-headers | wc -l)
    total_count=$(kubectl get pods -n argocd --no-headers | wc -l)
    if [ "$ready_count" -eq "$total_count" ] && [ "$total_count" -gt 0 ]; then
      exit 0
    else
      exit 1
    fi
  args:
    executable: /bin/bash
  register: argocd_status
  until: argocd_status.rc == 0
  retries: 60
  delay: 10
  changed_when: false

- name: Get ArgoCD initial admin password
  shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  register: argocd_password
  changed_when: false

- name: Display ArgoCD installation info
  debug:
    msg:
      - "ArgoCD installed successfully!"
      - ""
      - "Access ArgoCD UI via port-forward:"
      - "  kubectl port-forward svc/argocd-server -n argocd 8080:443"
      - "  Then open: https://localhost:8080"
      - ""
      - "Login credentials:"
      - "  Username: admin"
      - "  Password: {{ argocd_password.stdout }}"
      - ""
      - "IMPORTANT: Change the admin password after first login!"
      - "Using ArgoCD CLI:"
      - "  kubectl port-forward svc/argocd-server -n argocd 8080:443 &"
      - "  argocd login localhost:8080"
      - "  argocd account update-password"
